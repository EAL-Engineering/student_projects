# Phase 3, Step 1: Building the Scientific Container

* **File:** `3.1-container-build.md`
* **Date:** December 10, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Apptainer (formerly Singularity), CERN ROOT, Geant4
* **Goal:** Create the portable `lab-physics-v1.sif` container to standardise the user environment.

---

## 1. Overview

To reduce the support burden defined in the "Cade Relief" strategy, we will package the complex scientific dependencies (ROOT, Geant4) and custom lab utilities (`mvme2xy`) into a single, immutable container image.

This ensures that every job running on the cluster uses the exact same version of the software, regardless of the compute node's local library state.

## 2. Prepare the Build Environment

We will build the container on the Head Node. First, create a workspace directory to organize the definition files and local assets.

Create the build directory:

    mkdir -p /home/admin/containers/build
    cd /home/admin/containers/build

**Local Assets:**
Ensure the custom lab binaries or source code are present in this directory so they can be copied into the container.

    # Example: Copying current stable binaries to the build context
    cp /usr/local/bin/mvme2xy .
    cp /usr/local/bin/dat2xy .

## 3. Create the Definition File

The Apptainer definition file (`.def`) acts like a Dockerfile. It defines the base OS, the packages to install, and the environment variables to set.

Create the file `lab-physics.def`:

    nano lab-physics.def

Insert the following configuration. This builds from AlmaLinux 9 and installs the standard HEP (High Energy Physics) stack.

    Bootstrap: docker
    From: almalinux:9
    
    %files
        # Copy custom lab utilities from host to container
        mvme2xy /usr/local/bin/mvme2xy
        dat2xy /usr/local/bin/dat2xy
    
    %post
        # Install EPEL and update
        dnf install epel-release
        dnf update
    
        # Install Core Build Tools
        dnf install gcc-c++ make cmake git wget which
    
        # Install ROOT & Geant4 Dependencies
        dnf install libX11-devel libXpm-devel libXft-devel libXext-devel
        dnf install expat-devel xerces-c-devel python3-devel openssl-devel
    
        # Install CERN ROOT (Binary install for speed)
        cd /opt
        wget https://root.cern/download/root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
        tar -xzvf root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
        rm root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
    
        # (Optional) Geant4 Compilation Block
        # If Geant4 is required, uncomment and adjust version numbers
        # mkdir -p /opt/geant4/build
        # cd /opt/geant4
        # wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.2.0/geant4-v11.2.0.tar.gz
        # tar -xzf geant4-v11.2.0.tar.gz
    
        # Cleanup to reduce image size
        dnf clean all
    
    %environment
        # Set environment variables for users
        export ROOTSYS=/opt/root
        export PATH=$ROOTSYS/bin:$PATH
        export LD_library_PATH=$ROOTSYS/lib:$LD_LIBRARY_PATH
        export PYTHONPATH=$ROOTSYS/lib:$PYTHONPATH
        
        # Define Lab Standards
        export LAB_VERSION="v1.0-2025"

    %runscript
        # Default behavior when running the container
        echo "Physics Lab Container ($LAB_VERSION)"
        exec "$@"

## 4. Build the Image

Compile the definition file into the Singularity Image Format (`.sif`). This process requires root privileges.

Build the container:

    sudo apptainer build lab-physics-v1.sif lab-physics.def

## 5. Deployment

Once built, move the container to a shared location accessible by all users. Since `/home` is NFS shared across the cluster (as per Project Plan), placing it in a central library directory is ideal.

Create the central software repository:

    sudo mkdir -p /home/software/containers
    sudo mv lab-physics-v1.sif /home/software/containers/

Set permissions (Read-only for users):

    sudo chmod 644 /home/software/containers/lab-physics-v1.sif

## 6. Verification

Before instructing users to use the container, verify that the applications launch correctly.

**Test 1: Custom Utilities**
Verify `mvme2xy` is in the path and executable:

    apptainer exec /home/software/containers/lab-physics-v1.sif mvme2xy --help

**Test 2: CERN ROOT**
Verify ROOT launches and shows the correct version:

    apptainer exec /home/software/containers/lab-physics-v1.sif root -b -q

## 7. Next Steps

With the scientific environment packaged, we must now configure the Slurm "helper scripts" to make using this container seamless for the students.

Proceed to **3.2-slurm-wrappers.md**.