# Phase 3, Step 1: Building the Scientific Container

* **File:** `3.1-container-build.md`
* **Date:** December 12, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Apptainer, CERN ROOT, Geant4, Talys
* **Goal:** Create the portable `lab-physics-v1.sif` container to standardise the user environment.

---

## 1. Overview

We will package the complex scientific dependencies (ROOT, Geant4, Talys) and custom lab utilities into a single, immutable container image. This approach significantly reduces maintenance effort: instead of managing libraries on every compute node, we simply deploy a single file that contains the entire validated scientific stack. This ensures that every job running on the cluster uses the exact same software version, regardless of the node it lands on.

## 2. Prepare the Build Environment

We will build the container on the Head Node using the `eal` user. First, create a workspace directory to organize the definition files and local assets.

Create the build directory:

    mkdir -p /home/eal/containers/build
    cd /home/eal/containers/build

**Local Assets:**
Ensure the custom lab binaries and source tarballs are present in this directory so they can be copied into the container.

    # Copy custom lab utilities to the build context
    cp /usr/local/bin/mvme2xy .
    cp /usr/local/bin/dat2xy .
    
    # Ensure Talys source/installer is present (Assumed local for this example)
    # cp /home/eal/downloads/talys.tar.gz .

## 3. Create the Definition File

The Apptainer definition file (`.def`) defines the base OS, the packages to install, and the environment variables to set.

Create the file `lab-physics.def`:

    nano lab-physics.def

Insert the following configuration:

    Bootstrap: docker
    From: almalinux:9
    
    %files
        # Copy custom lab utilities from host to container
        mvme2xy /usr/local/bin/mvme2xy
        dat2xy /usr/local/bin/dat2xy
        
        # Copy Talys tarball (if building from local source)
        # talys.tar.gz /opt/src/talys.tar.gz
    
    %post
        # Install EPEL and update
        dnf install epel-release
        dnf update
    
        # Install Core Build Tools
        dnf install gcc-c++ make cmake git wget which
    
        # Install ROOT & Geant4 Dependencies
        dnf install libX11-devel libXpm-devel libXft-devel libXext-devel
        dnf install expat-devel xerces-c-devel python3-devel openssl-devel
    
        # --- Install CERN ROOT ---
        cd /opt
        wget https://root.cern/download/root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
        tar -xzvf root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
        rm root_v6.30.02.Linux-almalinux9-x86_64-gcc11.3.tar.gz
    
        # --- Install Geant4 (Mandatory) ---
        mkdir -p /opt/geant4/build
        cd /opt/geant4
        wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.2.0/geant4-v11.2.0.tar.gz
        tar -xzf geant4-v11.2.0.tar.gz
        # (Note: Full compilation commands omitted for brevity, but would go here)
        # cmake -DCMAKE_INSTALL_PREFIX=/opt/geant4/install ...
        # make -j20 && make install
    
        # --- Install Talys ---
        # (Assuming extraction and simple setup)
        mkdir -p /opt/talys
        # tar -xzf /opt/src/talys.tar.gz -C /opt/talys
    
        # Cleanup to reduce image size
        dnf clean all
    
    %environment
        # Set environment variables for users
        export ROOTSYS=/opt/root
        export PATH=$ROOTSYS/bin:/opt/talys/bin:$PATH
        export LD_LIBRARY_PATH=$ROOTSYS/lib:$LD_LIBRARY_PATH
        export PYTHONPATH=$ROOTSYS/lib:$PYTHONPATH
        
        # Geant4 Data
        export G4INSTALL=/opt/geant4/install
        export Geant4_DIR=$G4INSTALL
        
        # Define Lab Standards
        export LAB_VERSION="v1.0-2025-12-12"

    %runscript
        # Default behavior when running the container
        echo "Physics Lab Container ($LAB_VERSION)"
        exec "$@"

## 4. Build the Image

Compile the definition file into the Singularity Image Format (`.sif`). This process requires root privileges.

Build the container:

    sudo apptainer build lab-physics-v1.sif lab-physics.def

## 5. Deployment

Once built, move the container to the shared software repository created in Phase 2.5 (`/home/software`).

Move the container:

    sudo mv lab-physics-v1.sif /home/software/containers/

Set permissions:

    sudo chown eal:eal /home/software/containers/lab-physics-v1.sif
    sudo chmod 644 /home/software/containers/lab-physics-v1.sif

## 6. Verification

Before instructing users to use the container, verify that the applications launch correctly from the shared storage.

**Test 1: Custom Utilities**
Verify `mvme2xy` is in the path and executable:

    apptainer exec /home/software/containers/lab-physics-v1.sif mvme2xy --help

**Test 2: CERN ROOT**
Verify ROOT launches and shows the correct version:

    apptainer exec /home/software/containers/lab-physics-v1.sif root -b -q

**Test 3: Talys**
Verify Talys execution:

    apptainer exec /home/software/containers/lab-physics-v1.sif talys < /dev/null

## 7. Next Steps

With the scientific environment packaged, we must now configure the Slurm "helper scripts" to make using this container seamless for the students.

Proceed to **3.2-slurm-wrappers.md**.
