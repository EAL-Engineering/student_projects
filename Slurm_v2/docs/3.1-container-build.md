# Phase 3, Step 1: Building the Scientific Container

* **File:** `3.1-container-build.md`
* **Date:** December 12, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Apptainer, CERN ROOT, Geant4, Talys
* **Goal:** Create the portable `lab-physics-v1.sif` container to standardise the user environment.

---

## 1. Overview

We will package the scientific stack (ROOT, Geant4, Talys) into a single Apptainer container. This container will be built once on the Head Node and then distributed via the NFS share.

To avoid repeatedly downloading large source files during the build process, we will cache the tarballs locally first.

**Path Strategy:**
All scientific software will be installed into `/opt` within the container to keep the structure clean and consistent:

* `/opt/root`
* `/opt/geant4`
* `/opt/talys`
* `/opt/bin` (for custom lab utilities)

## 2. Prepare Local Cache

Downloading 2GB+ of source code every time you attempt a build is inefficient. We will download the source tarballs to the Head Node *once*, and then copy them into the container during the build.

Create the build directory:

    mkdir -p /home/eal/containers/build
    cd /home/eal/containers/build

**Download Sources (Run these commands on the Head Node):**

    # 1. Custom Utilities (Assumed present on host)
    cp /usr/local/bin/mvme2xy .
    cp /usr/local/bin/dat2xy .

    # 2. Geant4 11.4.0 Source
    wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.4.0/geant4-v11.4.0.tar.bz2

    # 3. Talys 2.0 Source
    wget https://nds.iaea.org/talys/talys.tar

## 3. Interactive Verification (Sandbox Mode)

Before writing the final definition file, it is highly recommended to test the compilation steps interactively. Apptainer allows you to boot a writable "sandbox" (directory) instead of a compressed file.

1. **Create a Sandbox:**

        sudo apptainer build --sandbox chroot_test/ docker://almalinux:9

2. **Enter the Sandbox (Writable):**

        sudo apptainer shell --writable chroot_test/

3. **Test Your Install Commands:**
    Inside this shell, you can manually run `dnf install ...`, `cmake ...`, and `make ...`. If a step fails, you can fix it immediately without restarting the whole build.

    *Once you are confident the commands work, exit the shell (`exit`) and proceed to Step 4 to create the automated definition file.*

## 4. Create the Definition File

Now that we have the sources locally and (optionally) verified the commands, we define the immutable build recipe.

Create `lab-physics.def`:

    nano lab-physics.def

Insert the following configuration:

    Bootstrap: docker
    From: almalinux:9
    
    %files
        # Copy local assets into the container's temporary /tmp directory
        mvme2xy                 /opt/bin/mvme2xy
        dat2xy                  /opt/bin/dat2xy
        geant4-v11.4.0.tar.bz2  /tmp/geant4-source.tar.bz2
        talys.tar               /tmp/talys-source.tar
    
    %post
        # --- 1. System Prerequisites ---
        dnf install epel-release
        dnf config-manager --set-enabled crb
        dnf update
    
        # Install Compilers & Build Tools
        # Note: gcc-gfortran is REQUIRED for Talys
        dnf install gcc-c++ gcc-gfortran make cmake git wget which tar bzip2
        
        # Install Geant4 Dependencies
        dnf install expat-devel xerces-c-devel libX11-devel libXmu-devel
    
        # Install CERN ROOT (via Package Manager)
        dnf install root python3-root
    
        # Create standard paths
        mkdir -p /opt/bin
    
        # --- 2. Install Talys 2.0 ---
        # Based on manual compilation instructions:
        # 1. Extract source
        # 2. Edit machine.f (if needed) - usually auto-detected on Linux
        # 3. Run talys-setup or compile manually
        
        cd /opt
        tar -xf /tmp/talys-source.tar
        # The tarball creates a 'talys' directory (e.g., /opt/talys)
        
        cd /opt/talys/source
        
        # [cite_start]Compile directly using gfortran as per manual [cite: 10]
        # We compile all .f and .f90 files and link them into the binary
        gfortran -c *.f *.f90
        gfortran *.o -o talys
        
        # Move binary to standard location
        mv talys /opt/bin/talys
        
        # Cleanup Talys build artifacts (optional, keeps source for reference)
        rm -f *.o
    
        # --- 3. Install Geant4 11.4.0 ---
        mkdir -p /opt/src
        cd /opt/src
        tar -xjf /tmp/geant4-source.tar.bz2
        
        mkdir -p /opt/src/geant4-v11.4.0/build
        cd /opt/src/geant4-v11.4.0/build
        
        # Compile with Broadwell Optimization (-march=native)
        cmake -DCMAKE_INSTALL_PREFIX=/opt/geant4 \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_CXX_FLAGS="-march=native" \
              -DGEANT4_INSTALL_DATA=ON \
              -DGEANT4_USE_OPENGL_X11=ON \
              -DGEANT4_USE_RAYTRACER_X11=ON \
              -DGEANT4_BUILD_MULTITHREADED=ON \
              ..
        
        make -j$(nproc)
        make install
        
        # --- 4. Cleanup ---
        cd /opt
        rm -rf /opt/src
        rm -f /tmp/*.tar*
        dnf clean all
    
    %environment
        # --- System Path ---
        export PATH=/opt/bin:$PATH
        
        # --- ROOT ---
        export PYTHONPATH=/usr/lib64/root:$PYTHONPATH
        
        # --- Geant4 ---
        . /opt/geant4/bin/geant4.sh
        
        # --- Talys ---
        # [cite_start]Talys requires knowing where its structure files are [cite: 45]
        # We generally set this in the environment or user input, but 
        # the binary is now in the PATH.
        
        export LAB_VERSION="v1.0-2025-12-12"

    %runscript
        echo "Physics Lab Container ($LAB_VERSION)"
        exec "$@"

## 5. Build the Final Image

Once the definition file is ready, build the production image. This will likely take 30-60 minutes due to the Geant4 compilation.

    sudo apptainer build lab-physics-v1.sif lab-physics.def

## 6. Verification

Test the container locally before deploying.

    # 1. Test Custom Tools
    apptainer exec lab-physics-v1.sif mvme2xy --help
    
    # 2. Test Talys
    apptainer exec lab-physics-v1.sif talys < /dev/null
    
    # 3. Test Geant4 Environment
    apptainer exec lab-physics-v1.sif env | grep G4INSTALL

## 7. Deployment

Move the verified image to the shared storage.

    sudo mv lab-physics-v1.sif /home/software/containers/
    sudo chown eal:eal /home/software/containers/lab-physics-v1.sif
    sudo chmod 644 /home/software/containers/lab-physics-v1.sif
    