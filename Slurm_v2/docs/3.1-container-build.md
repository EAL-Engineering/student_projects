# Phase 3, Step 1: Building the Scientific Container

* **File:** `3.1-container-build.md`
* **Date:** December 12, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Apptainer, CERN ROOT, Geant4, Talys
* **Goal:** Create the portable `lab-physics-v1.sif` container to standardise the user environment.

---

## 1. Overview

We will package the complex scientific dependencies (ROOT, Geant4, Talys) and custom lab utilities into a single, immutable container image. This approach significantly reduces maintenance effort: instead of managing libraries on every compute node, we simply deploy a single file that contains the entire validated scientific stack. This ensures that every job running on the cluster uses the exact same software version, regardless of the node it lands on.

## 2. Prepare the Build Environment

We will build the container on the Head Node using the `eal` user. First, create a workspace directory to organize the definition files and local assets.

Create the build directory:

    mkdir -p /home/eal/containers/build
    cd /home/eal/containers/build

**Local Assets:**
Ensure the custom lab binaries and source tarballs are present in this directory so they can be copied into the container.

    # Copy custom lab utilities to the build context
    cp /usr/local/bin/mvme2xy .
    cp /usr/local/bin/dat2xy .

## 3. Create the Definition File

The Apptainer definition file (`.def`) defines the base OS, the packages to install, and the environment variables to set.

Create the file `lab-physics.def`:

    nano lab-physics.def

Insert the following configuration. Note that we compile Geant4 11.4.0 from source to ensure optimization for our specific hardware (Broadwell/v4), while using the package manager for ROOT.

    Bootstrap: docker
    From: almalinux:9
    
    %files
        # Copy custom lab utilities from host to container
        mvme2xy /usr/local/bin/mvme2xy
        dat2xy /usr/local/bin/dat2xy
    
    %post
        # --- System Updates & Repositories ---
        dnf install epel-release
        dnf config-manager --set-enabled crb
        dnf update
    
        # --- Install Build Tools ---
        # Note: expat-devel and xerces-c-devel are critical for Geant4
        dnf install gcc-c++ make cmake git wget which tar bzip2
        dnf install expat-devel xerces-c-devel libX11-devel libXmu-devel
    
        # --- Install CERN ROOT ---
        # Installing via DNF as requested (requires EPEL)
        dnf install root python3-root
    
        # --- Install Geant4 (Source Compilation) ---
        # We build from source to enable Broadwell optimizations and internal datasets
        mkdir -p /opt/src
        cd /opt/src
        
        # Download Geant4 11.4.0 (using .bz2 for smaller download size)
        wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.4.0/geant4-v11.4.0.tar.bz2
        tar -xjf geant4-v11.4.0.tar.bz2
        
        mkdir -p /opt/src/geant4-v11.4.0/build
        cd /opt/src/geant4-v11.4.0/build
        
        # Configure CMake
        # -DGEANT4_INSTALL_DATA=ON:  Downloads the heavy physics datasets (Neutron, etc.) automatically
        # -DGEANT4_USE_OPENGL_X11=ON: Enables visualization support
        # -DGEANT4_BUILD_MULTITHREADED=ON: Enables MT support for parallel simulations
        cmake -DCMAKE_INSTALL_PREFIX=/opt/geant4 \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_CXX_FLAGS="-march=native" \              
              -DGEANT4_INSTALL_DATA=ON \
              -DGEANT4_USE_OPENGL_X11=ON \
              -DGEANT4_USE_RAYTRACER_X11=ON \
              -DGEANT4_BUILD_MULTITHREADED=ON \
              ..
        
        # Compile and Install (This will take significant time)
        make -j$(nproc)
        make install
        
        # Cleanup Source
        cd /opt
        rm -rf /opt/src
        
        # --- Install Talys 2.0 ---
        mkdir -p /opt/talys
        cd /opt/talys
        wget https://nds.iaea.org/talys/codes/talys.tar
        tar -xf talys.tar
        rm talys.tar
        # Note: Talys often requires a setup script or structure adjustment
        # depending on the tarball contents. We assume standard structure here.
    
        # --- Cleanup ---
        dnf clean all
    
    %environment
        # --- ROOT Environment ---
        # (dnf install root places binaries in /usr/bin, so no special path needed)
        export PYTHONPATH=/usr/lib64/root:$PYTHONPATH
        
        # --- Geant4 Environment ---
        # Source the official Geant4 setup script
        # This automatically sets G4INSTALL, G4LIB, and dataset paths
        . /opt/geant4/bin/geant4.sh
        
        # --- Talys Environment ---
        export PATH=/opt/talys/bin:$PATH
        
        # --- Lab Metadata ---
        export LAB_VERSION="v1.0-2025-12-12"

    %runscript
        echo "Physics Lab Container ($LAB_VERSION)"
        exec "$@"

## 4. Build the Image

Compile the definition file into the Singularity Image Format (`.sif`). This process requires root privileges.

**Warning:** Because we are compiling Geant4 from source, this build process will take significantly longer (30-60 minutes) and consume more CPU/RAM than the previous binary version.

Build the container:

    sudo apptainer build lab-physics-v1.sif lab-physics.def

## 5. Deployment

Once built, move the container to the shared software repository created in Phase 2.5 (`/home/software`).

Move the container:

    sudo mv lab-physics-v1.sif /home/software/containers/

Set permissions:

    sudo chown eal:eal /home/software/containers/lab-physics-v1.sif
    sudo chmod 644 /home/software/containers/lab-physics-v1.sif

## 6. Verification

Before instructing users to use the container, verify that the applications launch correctly from the shared storage.

**Test 1: Custom Utilities**
Verify `mvme2xy` is in the path and executable:

    apptainer exec /home/software/containers/lab-physics-v1.sif mvme2xy --help

**Test 2: CERN ROOT**
Verify ROOT launches and shows the correct version:

    apptainer exec /home/software/containers/lab-physics-v1.sif root -b -q

**Test 3: Geant4**
Verify Geant4 variables are loaded by sourcing the environment within the container:

    apptainer exec /home/software/containers/lab-physics-v1.sif env | grep G4
    # Should list G4INSTALL, G4NEUTRONHPDATA, etc.

## 7. Next Steps

With the scientific environment packaged, we must now configure the Slurm "helper scripts" to make using this container seamless for the students.

Proceed to **3.2-slurm-wrappers.md**.