# Phase 2, Step 1: Warewulf 4 Installation & Configuration

* **File:** `2.1-warewulf-install.md`
* **Date:** December 9, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Warewulf 4.x (via OpenHPC 3.x)
* **Goal:** Install the provisioning engine and configure it to work with an **External DHCP** (Endian Firewall).

---

## 1. Install Warewulf

Since we installed the OpenHPC repositories in the previous phase (`1.3-almalinux-install.md`), we can pull Warewulf directly.

```bash
# Install Warewulf 4 and basic OpenHPC compute utilities
dnf -y install warewulf-ohpc ohpc-base-computes
```

## 2. Configure Warewulf Controller

We need to edit the main configuration file to tell Warewulf about the Head Node's networking.

_File:_ /etc/warewulf/warewulf.conf

Edit the file to match the settings below.

**_Critical:_** Ensure ipaddr matches your bond0 static IP (10.0.0.91).

**_Critical:_** We will disable internal DHCP management in the configuration to prevent conflicts with the Endian Firewall.

```YAML
ipaddr: 10.0.0.91
netmask: 255.255.0.0
network: 10.0.0.0
#WAREWULF_INTERNAL_DHCP: 0  <-- (Conceptual note: we handle this by service management below)

warewulf:
  port: 9873
  secure: false
  update interval: 60
  # Ensure the tftp and http services bind to the bond0 IP
  syslog: false

dhcp:
  enabled: false   # <--- CRITICAL: Set this to false. Endian handles DHCP.
  
tftp:
  enabled: true
  
nfs:
  enabled: true
```

## 3. Initialize Services

Warewulf 4 uses the wwctl command to configure the underlying system services (TFTP, Nginx/Apache, NFS).

### A. Configure System Services

Run the configuration utility. Since we disabled DHCP in the config above, it should skip writing a dhcpd.conf.

```bash
wwctl configure --all
```

### B. Enable Host Services

We need to ensure the TFTP and HTTP servers (which serve the iPXE binaries and OS images) start on boot.

1. Enable the web server (OpenHPC usually pulls in httpd or nginx)

    ```bash
    systemctl enable --now httpd
    ```

2. Enable TFTP (Socket activated)

    ```bash
    systemctl enable --now tftp.socket
    ```

3. Enable Warewulf daemon (if applicable for background tasks)

    ```bash
    systemctl enable --now warewulfd
    ```

### C. Disable Local DHCP (Safety Check)

Ensure the local DHCP server is dead so it doesn't fight with the Endian firewall.

```bash
systemctl stop dhcpd
systemctl disable dhcpd
```

## 4. Import Container & Kernel

Warewulf 4 is container-native. We will import a base AlmaLinux 9 image which will become the root filesystem for the compute nodes.

### A. Import Base OS Image

This pulls the standard AlmaLinux 9 container from the Docker registry.

```bash
# This may take a few minutes depending on internet speed
wwctl container import docker://almalinux:9 almalinux-9
```

### B. Import Running Kernel

The compute nodes need a kernel to boot. We will use the kernel currently running on the Head Node (which was updated in 1.3-almalinux-install.md).

```bash
wwctl kernel import $(uname -r)
```

## 5. Configure SSH Keys

To allow seamless management (and enable users to run MPI jobs), we need passwordless SSH access from the Head Node to the Compute Nodes.

```bash
# Generate a new keypair for the cluster (if one doesn't exist)
ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N ""

# Configure Warewulf to inject this key into compute nodes
wwctl configure ssh
```

## 6. Verification

Before proceeding to build the node images, verify the Warewulf controller is healthy.

**Check Overlays:**

```bash
wwctl overlay list
# Should see 'host' and 'generic' overlays.
```

**Check Services:**

```bash
ss -tuln | grep :69
# Should see a listener on port 69 (TFTP).

ss -tuln | grep :80
# Should see a listener on port 80 (HTTP).
```

**Test TFTP (Optional but Recommended):** From the Head Node itself, try to fetch the iPXE binary that the Endian firewall will point to.

```bash
dnf -y install tftp
tftp 10.0.0.91 -c get ipxe.efi
# If successful, a file named 'ipxe.efi' will appear in your current dir.
rm ipxe.efi
```
