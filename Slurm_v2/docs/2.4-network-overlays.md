# Phase 2, Step 4: Network Bonding Overlays

* **File:** `2.4-network-overlays.md`
* **Date:** December 10, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Warewulf 4.x, NetworkManager
* **Goal:** Create a system overlay to inject LACP (802.3ad) bonding configurations into the compute nodes.

---

## 1. Overview

To achieve the aggregated 20Gbps bandwidth required for the Geant4 simulations and large dataset transfers, we must bond the two 10GbE interfaces on the Supermicro X10 nodes.

We will configure this using the modern **NetworkManager Keyfile** format (INI-style) stored in `/etc/NetworkManager/system-connections/`.

**Strategy:** We will create a dedicated system overlay named `lacp-bond`. By keeping this configuration separate from the generic system overlay, we retain the ability to easily "toggle" bonding off (by removing this overlay from the profile) should we need to debug network issues using single interfaces later.

**Hardware Assumption:** We assume the Supermicro X10 onboard 10GbE interfaces map to `eno1` and `eno2`. Use `ip link` on a booted node to verify this before finalizing.

## 2. Create the Overlay Structure

Create the new overlay directory structure:

    sudo wwctl overlay create lacp-bond

## 3. Define the Bond Interface (Template)

We will create the configuration for the logical bond interface (`bond0`).

**Technical Note on Templating:**
Because NetworkManager Keyfiles require strict formatting, we cannot use a generic placeholder IP. Instead, we append `.ww` to the filename. This tells Warewulf to parse the file as a template and inject the specific `{{ .Ipaddr }}` for each node *before* NetworkManager reads it.

Edit the bond configuration template:

    sudo wwctl overlay edit lacp-bond /etc/NetworkManager/system-connections/bond0.nmconnection.ww

Insert the following content (INI Format):

    [connection]
    id=bond0
    type=bond
    interface-name=bond0
    
    [bond]
    mode=802.3ad
    miimon=100
    
    [ipv4]
    method=manual
    address1={{ .Ipaddr }}/16
    
    [ipv6]
    method=disabled

## 4. Define the Slave Interfaces

We must configure the physical interfaces (`eno1` and `eno2`) to act as slaves to the bond master. These files do not require dynamic IP templating, so we can create them as standard static files (no `.ww` extension).

### 4.1 Interface 1 (eno1)

Edit the first slave interface:

    sudo wwctl overlay edit lacp-bond /etc/NetworkManager/system-connections/eno1.nmconnection

Insert the following content:

    [connection]
    id=eno1
    type=ethernet
    interface-name=eno1
    master=bond0
    slave-type=bond

### 4.2 Interface 2 (eno2)

Edit the second slave interface:

    sudo wwctl overlay edit lacp-bond /etc/NetworkManager/system-connections/eno2.nmconnection

Insert the following content:

    [connection]
    id=eno2
    type=ethernet
    interface-name=eno2
    master=bond0
    slave-type=bond

## 5. Set Permissions (Critical)

NetworkManager is security-conscious and may ignore configuration files that are world-readable. We must ensure the files in the overlay have strict permissions (600).

Set permissions on the overlay files:

    sudo wwctl overlay chmod lacp-bond /etc/NetworkManager/system-connections/bond0.nmconnection.ww 0600
    sudo wwctl overlay chmod lacp-bond /etc/NetworkManager/system-connections/eno1.nmconnection 0600
    sudo wwctl overlay chmod lacp-bond /etc/NetworkManager/system-connections/eno2.nmconnection 0600

## 6. Build and Verify the Overlay

Now that the files are in place, we must verify the overlay contents and build the structure.

List the files in the overlay to ensure they are correct:

    sudo wwctl overlay list -l lacp-bond

Build the overlay (this caches it for the nodes):

    sudo wwctl overlay build lacp-bond

## 7. Assign Overlay to Profile

We apply this overlay to the `default` profile so all compute nodes receive it.

Add the lacp-bond overlay to the default profile:

    sudo wwctl profile set default --systemoverlay lacp-bond

## 8. Next Steps

With the OS image created (Step 2.3) and the Network Overlay ready (Step 2.3), the next logical step is to boot a compute node and verify the stack.

1. **Boot Node 02:** Power on the first compute node via IPMI.
2. **Verify Bond:** Check `/proc/net/bonding/bond0` on the node.
3. **Throughput Test:** Run `iperf3` between Node 01 and Node 02.

## 9. Further Reading

* **Warewulf Overlays:** [Warewulf Overlay Management](https://warewulf.org/docs/main/contents/overlays.html)
* **Linux Kernel Bonding:** [Kernel.org Bonding Documentation](https://www.kernel.org/doc/Documentation/networking/bonding.txt)