# Phase 2, Step 2: Installing Open OnDemand

* **File:** `2.2-open-ondemand.md`
* **Date:** December 18, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Open OnDemand 3.1, mod_authnz_pam
* **Prerequisites:** Phase 2.1 (Slurm Controller active), Phase 1.3 (SSL Certs & Firewall configured)
* **Goal:** Install and configure the web portal service to use **Local System Authentication**.

---

## 1. Overview

With the Slurm Controller active, we can now install the Open OnDemand (OOD) portal. We will configure the portal to authenticate users against the local system (PAM), meaning users will log in with the same username/password they use for SSH.

## 2. Install Packages

We install the OOD base packages and the Apache PAM module required for local authentication.

    dnf install ondemand ondemand-selinux mod_authnz_pam

* **mod_authnz_pam:** Allows the web server to check passwords against the local `/etc/shadow` file (via PAM).

## 3. Configuration

### 3.1 Configure System Authentication (PAM)

To allow the web server to verify user passwords, we must define a PAM service and grant the web user (`apache`) permission to read the shadow password file.

1. **Create PAM Service:**
    Copy the standard SSH configuration to create a service definition for OnDemand.

        cp /etc/pam.d/sshd /etc/pam.d/ondemand

2. **Grant Shadow Access:**
    By default, only root can read password hashes. We must allow the `apache` group to read `/etc/shadow` so the module can verify logins.

        chgrp apache /etc/shadow
        chmod 640 /etc/shadow

### 3.2 Portal Configuration (SSL & Auth)

We configure the portal to use the system certificates and the PAM authentication provider.

Edit `/etc/ood/config/ood_portal.yml`:

    servername: null
    ssl:
      - 'SSLCertificateFile "/etc/pki/tls/certs/localhost.crt"'
      - 'SSLCertificateKeyFile "/etc/pki/tls/private/localhost.key"'
    auth:
      - 'AuthType Basic'
      - 'AuthName "Open OnDemand"'
      - 'AuthBasicProvider PAM'
      - 'AuthPAMService ondemand'
      - 'Require valid-user'
    # Map the authenticated user to the system user
    user_map_cmd: "/opt/ood/ood_auth_map/bin/ood_auth_map.regex"

### 3.3 Cluster Definition

We must tell OOD how to talk to the local Slurm controller.

Create `/etc/ood/config/clusters.d/my_cluster.yml`:

    v2:
      metadata:
        title: "Nuclear Physics Cluster"
      login:
        host: "localhost"
      job:
        adapter: "slurm"
        cluster: "cluster"
        bin: "/usr/bin"
        conf: "/etc/slurm/slurm.conf"
      batch_connect:
        basic:
          script_wrapper: "module purge\n%s"
        vnc:
          script_wrapper: "module purge\n%s"

## 4. Apply Changes & Start Services

Generate the Apache configuration and start the services.

**Note:** We do *not* need `ondemand-dex` for local PAM authentication.

    # Update Apache config based on ood_portal.yml
    /opt/ood/ood-portal-generator/sbin/update_ood_portal

    # Enable and Start Apache HTTPD
    systemctl enable --now httpd

    # Ensure Dex is disabled (not used for local auth)
    systemctl disable --now ondemand-dex

## 5. Next Steps

The web portal is now active and accepting local system logins. We now proceed to building the operating system image for the compute nodes.

Proceed to **2.3-master-image.md**.
