# Phase 3, Step 3: Final System Validation & Commissioning

* **File:** `3.3-final-validation.md`
* **Date:** December 18, 2025
* **Target:** Node 01 (Head Node)
* **Software:** iperf3, Slurm, Apptainer
* **Goal:** Verify the 20Gbps network throughput and execute a "Golden Ticket" scientific job to certify the cluster for production.

---

## 1. Overview

Before we invite users to the system (Phase 4), we must validate that the infrastructure meets the performance goals defined in the Project Plan.

**Validation Criteria:**

1. **Network:** Achieve >18 Gbps aggregated bandwidth between nodes (validating LACP).
2. **Scheduler:** Successfully dispatch jobs to all compute nodes.
3. **Science:** Execute a complete Geant4 simulation using the simplified wrapper workflow.

## 2. Network Validation (iperf3)

To test the LACP bond, we must use parallel streams. A single TCP stream is limited by the hash algorithm to one physical link (10Gbps). Using multiple streams (`-P`) forces the switch to distribute traffic across both cables.

### 2.1 Start Server (Head Node)

On **Node 01**, start the iperf3 server:

    iperf3 -s

### 2.2 Run Client Test (Compute Node)

SSH into **node02** and run the test back to the head node.

    ssh node02
    iperf3 -c 10.0.0.91 -P 4 -t 10

**Success Metric:**

* **Sum** Bandwidth: **18.5 â€“ 19.8 Gbits/sec**
* *Note:* If you see ~9.4 Gbps, the LACP hashing is not balancing correctly (check switch config).

## 3. Storage Validation (NFS)

Since users will be writing simulation data to `/home`, we need to ensure the NFS share doesn't choke under load.

**Test:** Write a 1GB file from a compute node to the shared storage.

    ssh node02
    dd if=/dev/zero of=/home/eal/write_test.img bs=1G count=1 oflag=direct

**Success Metric:**

* Write Speed: **> 400 MB/s** (roughly 3.2 Gbps)
* *Note:* This confirms that disk I/O (and not just raw network speed) is sufficient.

## 4. Scientific Workflow Validation ("The Golden Ticket")

We will now run a "real" job using the **wrappers** we created in Step 3.2. This tests the entire chain: *User -> Wrapper -> Slurm -> Compute Node -> Apptainer -> Geant4*.

### 4.1 Prepare the Test Data

Create a temporary workspace on the shared storage:

    mkdir -p /home/eal/validation_test
    cd /home/eal/validation_test

### 4.2 Test Talys Submission

Create a minimal Talys input file `gold.inp`:

    Au
    197
    energy 14.

Submit it using the wrapper:

    sub_talys gold.inp

**Verify:**

1. Check `squeue`: Ensure job is `R` (Running) or `CD` (Completed).
2. Check Output: `ls -l` should show `talys.out`.
3. Inspect Content: `grep "Cross section" talys.out` should return physics data.

### 4.3 Test Geant4 (Visual/Interactive)

If you have X11 forwarding enabled (SSH with `-Y`), you can test the interactive wrapper.

    root -b
    # Inside ROOT:
    root [0] new TBrowser()

**Success Metric:**

* The ROOT graphical browser window appears on your local desktop. This confirms that X11 forwarding passes through the container correctly.

## 5. Cluster Commissioning

If all tests pass, the cluster is ready for "Early Access" users.

**Final Health Check:**
Run the following command to ensure all nodes are responding and idle:

    sinfo -N -l

**Expected Output:**

    NODELIST   PARTITION    STATE    CPUS    S:C:T    MEMORY
    node02     normal* idle     40      2:20:1   128000
    node03     normal* idle     40      2:20:1   128000
    node04     normal* idle     40      2:20:1   128000

## 6. Next Steps

The hardware and software core are finished. We now move to **Phase 4: User Onboarding**, starting with the installation of the web portal.

Proceed to **4.1-open-ondemand.md**.
