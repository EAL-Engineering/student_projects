# Phase 4, Step 1: Deploying Open OnDemand

* **File:** `4.1-open-ondemand.md`
* **Date:** December 18, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Open OnDemand 3.1, Apache HTTPD
* **Goal:** Install and configure the web-based portal to allow users to submit jobs and manage files without using the command line.

---

## 1. Overview

Open OnDemand (OOD) provides a graphical interface to the cluster. It allows students to:

1. **Manage Files:** Upload/Download data via a web browser.
2. **Submit Jobs:** Use a "Job Composer" to run simulations.
3. **Shell Access:** Open a terminal in the browser.

We will install OOD on the Head Node and configure it to talk to our local Slurm controller.

## 2. Install Open OnDemand

### 2.1 Add Repositories

OOD requires the Open OnDemand RPM repository.

    dnf install -y https://yum.osc.edu/ondemand/3.1/ondemand-release-web-3.1-1.el9.noarch.rpm

### 2.2 Install Packages

Install the core application and the SELinux policies.

    dnf install -y ondemand ondemand-selinux

## 3. Configuration

### 3.1 SSL Certificate (Self-Signed)

OOD requires HTTPS. Since this is an internal lab machine, we will generate a self-signed certificate.

    mkdir -p /etc/pki/tls/private
    mkdir -p /etc/pki/tls/certs
    
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
      -keyout /etc/pki/tls/private/localhost.key \
      -out /etc/pki/tls/certs/localhost.crt \
      -subj "/C=US/ST=Ohio/L=Athens/O=PhysicsLab/CN=$(hostname)"

### 3.2 Configure the Portal

Edit the OOD portal configuration to use these certificates.

Edit `/etc/ood/config/ood_portal.yml`:

    servername: null
    ssl:
      - 'SSLCertificateFile "/etc/pki/tls/certs/localhost.crt"'
      - 'SSLCertificateKeyFile "/etc/pki/tls/private/localhost.key"'
    auth:
      - 'AuthType Basic'
      - 'AuthName "Open OnDemand"'
      - 'AuthUserFile "/etc/apache2/.htpasswd"'  # We will use simple auth for now

*Note: For a university network, we typically integrate with LDAP/CAS, but for this standalone cluster, we will use local System Authentication (PAM) or Basic Auth. For simplicity in this phase, we will assume PAM (System User) authentication is handled by the default Apache configuration.*

### 3.3 Define the Cluster

We must tell OOD how to talk to Slurm. This is done by adding a cluster definition file.

Create `/etc/ood/config/clusters.d/my_cluster.yml`:

    v2:
      metadata:
        title: "Nuclear Physics Cluster"
      login:
        host: "localhost"
      job:
        adapter: "slurm"
        cluster: "cluster"
        bin: "/usr/bin"
        conf: "/etc/slurm/slurm.conf"
      batch_connect:
        basic:
          script_wrapper: "module purge\n%s"
        vnc:
          script_wrapper: "module purge\n%s"

## 4. Apply Changes & Start Services

Update the Apache configuration based on the settings above and start the services.

    # Generate Apache config
    /opt/ood/ood-portal-generator/sbin/update_ood_portal
    
    # Enable and Start Apache
    systemctl enable --now httpd
    
    # Enable and Start OOD PUN Service
    systemctl enable --now ondemand-dex

## 5. Firewall Configuration

Allow web traffic through the firewall.

    firewall-cmd --permanent --add-service=http
    firewall-cmd --permanent --add-service=https
    firewall-cmd --reload

## 6. Verification

1. Open a web browser on your laptop.
2. Navigate to `https://10.0.0.91` (or the Head Node's external IP).
3. Accept the security warning (due to the self-signed certificate).
4. Log in with the `eal` username and password.
5. **Test:** Click "Files" -> "Home Directory". You should see your files.
6. **Test:** Click "Jobs" -> "Active Jobs". You should see the cluster queue.

## 7. Next Steps

With the interface active, we have completed the technical deployment. The final step is documenting the workflow for the students.

Proceed to **4.2-user-documentation.md**.
