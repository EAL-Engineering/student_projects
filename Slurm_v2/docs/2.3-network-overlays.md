# Phase 2, Step 3: Network Bonding Overlays

* **File:** `2.3-network-overlays.md`
* **Date:** December 10, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Warewulf 4.x, NetworkManager
* **Goal:** Create a system overlay to inject LACP (802.3ad) bonding configurations into the compute nodes.

---

## 1. Overview

To achieve the aggregated 20Gbps bandwidth required for the Geant4 simulations and large dataset transfers, we must bond the two 10GbE interfaces on the Supermicro X10 nodes.

While Warewulf handles basic IP assignment, complex LACP bonding configurations on EL9 are best handled by injecting specific NetworkManager configurations via a System Overlay. This ensures that when the node boots, `bond0` is brought up immediately.

**Hardware Assumption:** We assume the Supermicro X10 onboard 10GbE interfaces map to `eno1` and `eno2`. Use `ip link` on a booted node to verify this before finalizing.

## 2. Create the Overlay Structure

We will create a new overlay named `lacp-bond`. This keeps the networking config separate from the generic system overlay, allowing us to toggle it if we need to debug single-interface booting later.

Create the overlay directory structure:

    sudo wwctl overlay create lacp-bond

## 3. Define the Bond Interface

We need to create the configuration file for the logical bond interface (`bond0`). We will use the standard `ifcfg` format located in `/etc/sysconfig/network-scripts/`.

**Technical Note on Templating:**
Warewulf allows for dynamic IP injection using template tags (e.g., `{{ .Ipaddr }}`). However, standard practice is to rely on Warewulf's internal network provisioner to overwrite the specific `IPADDR` and `PREFIX` lines at runtime based on the node registration data. The configuration below uses a placeholder IP (`10.0.0.x`), which Warewulf will automatically replace with the correct static IP for each node when the overlay is built and served.

**Configuration Details:**
The `BONDING_OPTS` line specifies Mode 4 (802.3ad) and a Monitoring Interval of 100ms.

Edit the bond configuration file:

    sudo wwctl overlay edit lacp-bond /etc/sysconfig/network-scripts/ifcfg-bond0

Insert the following content:

    DEVICE=bond0
    NAME=bond0
    TYPE=Bond
    BONDING_MASTER=yes
    IPADDR=10.0.0.x
    PREFIX=16
    ONBOOT=yes
    BOOTPROTO=none
    BONDING_OPTS="mode=802.3ad miimon=100"
    NM_CONTROLLED=yes

## 4. Define the Slave Interfaces

We must configure the physical interfaces (`eno1` and `eno2`) to act as slaves to the bond master.

### 4.1 Interface 1 (eno1)

Edit the first slave interface:

    sudo wwctl overlay edit lacp-bond /etc/sysconfig/network-scripts/ifcfg-eno1

Insert the following content:

    DEVICE=eno1
    TYPE=Ethernet
    BOOTPROTO=none
    ONBOOT=yes
    MASTER=bond0
    SLAVE=yes
    NM_CONTROLLED=yes

### 4.2 Interface 2 (eno2)

Edit the second slave interface:

    sudo wwctl overlay edit lacp-bond /etc/sysconfig/network-scripts/ifcfg-eno2

Insert the following content:

    DEVICE=eno2
    TYPE=Ethernet
    BOOTPROTO=none
    ONBOOT=yes
    MASTER=bond0
    SLAVE=yes
    NM_CONTROLLED=yes

## 5. Build and Verify the Overlay

Now that the files are in place, we must verify the overlay contents and build the structure.

List the files in the overlay to ensure they are correct:

    sudo wwctl overlay list -l lacp-bond

Build the overlay (this caches it for the nodes):

    sudo wwctl overlay build lacp-bond

## 6. Assign Overlay to Profile

We apply this overlay to the `default` profile so all compute nodes receive it.

Add the lacp-bond overlay to the default profile:

    sudo wwctl profile set default --systemoverlay lacp-bond

## 7. Next Steps

With the OS image created (Step 2.2) and the Network Overlay ready (Step 2.3), the next logical step is to boot a compute node and verify the stack.

1.  **Boot Node 02:** Power on the first compute node via IPMI.
2.  **Verify Bond:** Check `/proc/net/bonding/bond0` on the node.
3.  **Throughput Test:** Run `iperf3` between Node 01 and Node 02.

## 8. Further Reading

* **RHEL/AlmaLinux 9 Networking:** [Configuring Network Bonding](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_networking/configuring-network-bonding_configuring-and-managing-networking)
* **Warewulf Overlays:** [Warewulf Overlay Management](https://warewulf.org/docs/main/contents/overlays.html)
* **Linux Kernel Bonding:** [Kernel.org Bonding Documentation](https://www.kernel.org/doc/Documentation/networking/bonding.txt)