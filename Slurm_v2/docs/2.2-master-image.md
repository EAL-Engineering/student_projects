**2.2-master-image.md**

# 2.2 Creating the Master VNFS Image (AlmaLinux 9)

* **Phase:** 2 (The Stateless Fabric)
* **Leads:** Greg & Don
* **Context:** This document details the procedure for building the stateless operating system image (VNFS) for Compute Nodes 02-04.

---

## 1. Overview

As defined in the project plan, the compute nodes will boot statelessly via Warewulf 4. We will use **AlmaLinux 9** as the base to ensure binary compatibility with standard HEP tools (CERN ROOT, Geant4).

This image serves as the container for the runtime environment. It must include:
1.  **Slurm 24.11** Daemons and dependencies.
2.  **Apptainer** (for the "Cade Relief" container strategy).
3.  **Network Tools** (required for the LACP bonding script validation).
4.  **Scientific Libraries** (standard dependencies).

## 2. Import the Base Container

First, import the standard AlmaLinux 9 image from the public Docker registry into the Warewulf data store on the Head Node (Node 01). We will name this image `almalinux-9-hpc`.

	# Import the base image from Docker Hub
	sudo wwctl import docker://almalinux:9 almalinux-9-hpc --setdefault

## 3. Customize the Image (Sandboxing)

We need to install the OpenHPC repositories, the Slurm client/daemon, and the validation tools identified in Phase 3 (`iperf3`).

Open a shell into the container image:

	# Open a chroot shell into the VNFS image
	sudo wwctl container shell almalinux-9-hpc

### 3.1 Repository Setup

Inside the container shell, install the necessary repositories (EPEL and OpenHPC).

	# Install EPEL (Extra Packages for Enterprise Linux)
	dnf -y install epel-release
	
	# Install the OpenHPC repository (targeting EL9)
	dnf -y install http://repos.openhpc.community/OpenHPC/3/CentOS_9/x86_64/ohpc-release-3-1.el9.x86_64.rpm
	
	# Update all packages to latest versions
	dnf -y update

### 3.2 Install Core Drivers and Network Tools

To support the LACP bonding strategy and the validation steps in Phase 3, we need specific network utilities.

	# Install network configuration and bonding tools
	dnf -y install NetworkManager NetworkManager-team iproute
	
	# Install diagnostic tools for Phase 3 validation
	dnf -y install ethtool iperf3
	
	# Install standard editors and utilities for debugging
	dnf -y install vim nano bash-completion wget

### 3.3 Install Scheduler and Runtime Components

We must install the Slurm client and daemon (slurmd), along with the authentication service (Munge).

	# Install Slurm client and daemon from OpenHPC repo
	dnf -y install ohpc-slurm-client ohpc-slurm-slurmd
	
	# Install Munge for authentication
	dnf -y install munge
	
	# Enable Munge execution (required for Slurm to start)
	systemctl enable munge

### 3.4 Install Container Runtime (Apptainer)

As per the "Cade Relief" strategy, compute nodes must be able to execute the `lab-physics-v1.sif` container.

	# Install Apptainer
	dnf -y install apptainer

### 3.5 Cleanup and Exit

Clean the package cache to reduce the image size (to speed up TFTP transfer times) and exit the sandbox.

	# Clean DNF cache
	dnf clean all
	
	# Exit the container shell
	exit

## 4. Build the VNFS Image

Once the customization is complete, "build" the container. This compresses the directory structure into a bootable VNFS image that the compute nodes can pull over the network.

	# Build the final VNFS image
	sudo wwctl container build almalinux-9-hpc

## 5. Next Steps

The image is now ready. The next steps in Phase 2 involve configuring the overlays to inject the specific bonding configuration.

1.  **Configure Kernel:** Ensure the kernel arguments in the Warewulf profile allow for the bonded interface initialization.
2.  **Create Overlay:** Create the `ifcfg-bond0` system overlay (See document *2.3-network-overlays.md*).
3.  **Assign Profile:** Assign this image to the `compute` profile.

	# Assign the new image to the default node profile
	sudo wwctl profile set default --container almalinux-9-hpc