# Phase 2, Step 2: Creating the Master VNFS Image

* **File:** `2.2-master-image.md`
* **Date:** December 10, 2025
* **Target:** Node 01 (Head Node)
* **Software:** Warewulf 4.x, AlmaLinux 9, OpenHPC 3.x
* **Goal:** Build the stateless operating system image (VNFS) for Compute Nodes 02-04, including Slurm and Scientific Libraries.

---

## 1. Overview

As defined in the project plan, the compute nodes will boot statelessly via Warewulf 4. We will use **AlmaLinux 9** as the base to ensure binary compatibility with standard HEP tools (CERN ROOT, Geant4).

This image serves as the container for the runtime environment. It must include:
1.  **Slurm 24.11** Daemons and dependencies.
2.  **Apptainer** (for the "Cade Relief" container strategy).
3.  **Network Tools** (required for the LACP bonding script validation).
4.  **Scientific Libraries** (Specific dependencies for ROOT and Geant4, including CMake, GCC C++, X11 headers, and Expat).

## 2. Import the Base Container

First, import the standard AlmaLinux 9 image from the public Docker registry into the Warewulf data store on the Head Node (Node 01). We will name this image `almalinux-9-hpc`.

Import the base image from Docker Hub:

	sudo wwctl import docker://almalinux:9 almalinux-9-hpc --setdefault

## 3. Customize the Image (Sandboxing)

We need to install the OpenHPC repositories, the Slurm client/daemon, and the validation tools identified in Phase 3 (`iperf3`).

Open a chroot shell into the VNFS image:

	sudo wwctl container shell almalinux-9-hpc

### 3.1 Repository Setup

Inside the container shell, install the necessary repositories.

Install EPEL (Extra Packages for Enterprise Linux):

	dnf install epel-release

Install the OpenHPC repository (targeting EL9):

	dnf install http://repos.openhpc.community/OpenHPC/3/CentOS_9/x86_64/ohpc-release-3-1.el9.x86_64.rpm

Update all packages to latest versions:

	dnf update

### 3.2 Install Core Drivers and Network Tools

To support the LACP bonding strategy and the validation steps in Phase 3, we need specific network utilities.

Install network configuration and bonding tools:

	dnf install NetworkManager NetworkManager-team iproute

Install diagnostic tools for Phase 3 validation:

	dnf install ethtool iperf3

Install standard editors and utilities for debugging:

	dnf install vim nano bash-completion wget

### 3.3 Install Scheduler and Runtime Components

We must install the Slurm client and daemon (slurmd), along with the authentication service (Munge).

Install Slurm client and daemon from OpenHPC repo:

	dnf install ohpc-slurm-client ohpc-slurm-slurmd

Install Munge for authentication:

	dnf install munge

Enable Munge execution (required for Slurm to start):

	systemctl enable munge

### 3.4 Install Container Runtime (Apptainer)

As per the "Cade Relief" strategy, compute nodes must be able to execute the `lab-physics-v1.sif` container.

Install Apptainer:

	dnf install apptainer

### 3.5 Install Scientific Libraries & Development Tools

To support the compilation and execution of CERN ROOT and Geant4 locally (if not using containers), we must install the standard Physics dependencies.

Install C++ compilers and build tools:

	dnf install gcc-c++ make cmake git

Install X11 and Graphics headers (Required for ROOT visualization):

	dnf install libX11-devel libXpm-devel libXft-devel libXext-devel

Install XML parsers (Required for Geant4 macro processing):

	dnf install expat-devel xerces-c-devel

### 3.6 Cleanup and Exit

Clean the package cache to reduce the image size (to speed up TFTP transfer times) and exit the sandbox.

Clean DNF cache:

	dnf clean all

Exit the container shell:

	exit

## 4. Build the VNFS Image

Once the customization is complete, "build" the container. This compresses the directory structure into a bootable VNFS image that the compute nodes can pull over the network.

Build the final VNFS image:

	sudo wwctl container build almalinux-9-hpc

## 5. Next Steps

The image is now ready. The next steps in Phase 2 involve configuring the overlays to inject the specific bonding configuration.

1.  **Configure Kernel:** Ensure the kernel arguments in the Warewulf profile allow for the bonded interface initialization.
2.  **Create Overlay:** Create the `ifcfg-bond0` system overlay (See document *2.3-network-overlays.md*).
3.  **Assign Profile:** Assign this image to the `compute` profile.

Assign the new image to the default node profile:

	sudo wwctl profile set default --container almalinux-9-hpc

## 6. Further Reading

For more detailed documentation on the tools used in this image build, refer to the following resources:

* **Warewulf Control (wwctl):** [Warewulf 4 User Guide](https://warewulf.org/docs/main/)
* **Slurm Workload Manager:** [Slurm Quick Start Guide](https://slurm.schedmd.com/quickstart.html)
* **Apptainer:** [Apptainer User Guide](https://apptainer.org/docs/user/main/)